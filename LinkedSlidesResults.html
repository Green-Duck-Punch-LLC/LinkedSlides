<!DOCTYPE html>
<!--
Linked Slides Add-on - HTML for the results dialog.
Copyright (C) 2025 Green Duck Punch, LLC

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.

This file is part of the Linked Slides Add-on. The Linked Slides Add-on is
dual-licensed under the AGPLv3 and a commercial/proprietary license.
For commercial use or specific licensing terms within Google's proprietary
environment, please contact Green Duck Punch, LLC.
-->
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <style>
    :root {
      --bg-color: #f7fafc;
      --text-color: #222;
    }
    body {
      background-color: var(--bg-color);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    
    #container {
      max-width: 90%;
      margin: auto;
      text-align: center;
      position: relative;
      background-color: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      & p {
        margin-bottom: 1rem;
      }
    }

    #errors {
      margin: 1rem 0;
    }
    #container table {
      width: 100%;
      border: 1px solid oklab(from var(--bg-color) calc(l * 0.9) a b);
      & > :not(:last-child), & > tbody > :not(:last-child) {
        border-top-width: 0px;
        border-bottom-width: 1px;
        border-color: oklab(from var(--bg-color) calc(l * 0.2) a b);
      }

      & thead {
        background-color: oklab(from var(--bg-color) calc(l * 0.9) a b);
      }
      & th, & td {
        padding: 0.75rem 1.5rem;
        text-align: left;
      }
      & th {
        text-transform: uppercase;
      }
    }

    /* Dropdown styles */
    .dropdown {
      position: relative;
      display: inline-block;
      width: 100%; /* Make dropdown take full width of th */
    }
    .dropdown-content {
      display: none;
      position: absolute; /* Changed to absolute for portal pattern */
      background-color: #f9f9f9;
      min-width: 200px; /* Adjust as needed */
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1000; /* Increased z-index */
      padding: 10px;
      border-radius: 0.25rem;
      max-height: 250px; /* Scrollable if many options, adjusted for ~10 items */
      overflow-y: auto;
      text-align: left; /* Ensure checkboxes align left */
    }
    .dropdown-content label {
      display: block;
      margin-bottom: 5px;
      cursor: pointer;
    }
    .dropdown-item {
      padding: 8px 12px;
      cursor: pointer;
      display: block;
      text-align: left;
      /* Reset button-specific styles from add-ons1.css */
      background: none;
      border: none;
      border-radius: 0;
      box-shadow: none;
      width: 100%;
      margin: 0;
      font-family: inherit;
      font-size: inherit;
      font-weight: normal;
      color: inherit;
      height: auto;
      line-height: inherit;
    }
    .dropdown-item:hover {
      background-color: #f1f1f1;
      /* Ensure hover doesn't re-introduce button styles */
      border: none;
      box-shadow: none;
    }
    .dropdown-divider {
      margin: 0.5rem 0;
      border: 0;
      border-top: 1px solid #e2e8f0;
    }
    .dropdown-button span{
      flex-grow: 1; /* Allow text to grow */
      text-align: left;
      margin-right: 0.5rem; /* Space before arrow */
    }
    /* Style for the small dropdown arrow */
    .dropdown-arrow {
      font-size: 1.2em; /* Make it visible */
      line-height: 1; /* Align with text */
    }
    .dropdown-button:focus {
      outline: 2px solid #4285f4;
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div id="container">
    <? if (anyLinkedResults){ ?>
      <p class="gray">The following slides are involved in linking relationships:</p>
    <? } else if (displayRowsJson.length > 2 && !anyLinkedResults) { // Check if displayRowsJson is not just '[]' ?>
      <p class="gray">No linked slides were found in the selected presentations for your currently selected slide(s).</p>
    <? } ?>

    <? if (errors && errors.length > 0) { ?>
      <div id="errors" class="error">
        <h3>Errors encountered:</h3>
        <ul>
          <? errors.forEach(error => { ?>
            <li><?= error ?></li>
          <? }); ?>
        </ul>
      </div>
    <? } ?>

    <table>
      <thead>
        <tr>
          <th scope="col" id="th-sourceSlidePageNumber">
            <div class="dropdown">
                <button type="button" class="dropdown-button" data-column="sourceSlidePageNumber" data-target="filter-sourceSlidePageNumber">
                    <span>Source Slide #</span> <span class="dropdown-arrow">▼</span>
                </button>
                <!-- Dropdown content will be moved here by JS -->
            </div>
          </th>
          <th scope="col" id="th-targetPresentationName">
             <div class="dropdown">
                <button type="button" class="dropdown-button" data-column="targetPresentationName" data-target="filter-targetPresentationName">
                    <span>Target Presentation</span> <span class="dropdown-arrow">▼</span>
                </button>
                <!-- Dropdown content will be moved here by JS -->
            </div>
          </th>
          <th scope="col" id="th-targetSlidePageNumber">
            <div class="dropdown">
                <button type="button" class="dropdown-button" data-column="targetSlidePageNumber" data-target="filter-targetSlidePageNumber">
                    <span>Target Slide #</span> <span class="dropdown-arrow">▼</span>
                </button>
                <!-- Dropdown content will be moved here by JS -->
            </div>
          </th>
        </tr>
      </thead>
      <tbody id="resultsTableBody">
        <!-- Table rows will be rendered by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Global container for dropdowns to prevent clipping -->
  <div id="global-dropdown-container"></div>

  <script>
    // Data passed from Apps Script. Using JSON.parse to ensure proper object conversion.
    let tableData = JSON.parse('<?= displayRowsJson ?>');
    // activePresentationId is passed from the Apps Script server-side
    const activePresentationId = '<?= activePresentationId ?>';

    // Store original data for filtering resets
    const originalTableData = JSON.parse('<?= displayRowsJson ?>');

    // Object to store current filter selections for each column
    const activeFilters = {
        sourceSlidePageNumber: new Set(),
        targetPresentationName: new Set(),
        targetSlidePageNumber: new Set()
    };

    // Store references to the original dropdown content elements (before they are moved)
    const dropdownContentCache = {};

    /**
     * Renders the table body based on the current tableData.
     */
    function renderTable() {
        const tbody = document.getElementById('resultsTableBody');
        tbody.innerHTML = ''; // Clear existing rows

        tableData.forEach(rowData => {
            const row = tbody.insertRow();
            // Source Slide # (with link to source slide if applicable)
            const sourceSlideCell = row.insertCell();
            if (rowData.sourceSlideId){ // Check if sourceSlideId exists for linking
                sourceSlideCell.innerHTML = "<a href=\"https://docs.google.com/presentation/d/" + activePresentationId + "/edit#slide=id." + rowData.sourceSlideId + "\" target=\"_blank\">" + rowData.sourceSlidePageNumber + "</a>";
            } else {
                sourceSlideCell.textContent = rowData.sourceSlidePageNumber; // Just display number if no ID
            }

            // Target Presentation Name (with link)
            const targetPresCell = row.insertCell();
            if (rowData.targetPresentationId){
                targetPresCell.innerHTML = "<a href=\"https://docs.google.com/presentation/d/" + rowData.targetPresentationId + "/edit\" target=\"_blank\">" + rowData.targetPresentationName + "</a>";
            } else {
                targetPresCell.textContent = '';
            }

            // Target Slide # (with link to target slide if applicable)
            const targetSlideCell = row.insertCell();
            if (rowData.targetSlideObjectId){
                let url = "https://docs.google.com/presentation/d/" + rowData.targetPresentationId + "/edit#slide=id." + rowData.targetSlideObjectId;
                targetSlideCell.innerHTML = "<a href=\"" + url + "\" target=\"_blank\">" + rowData.targetSlidePageNumber + "</a>";
            } else {
                targetSlideCell.textContent = '';
            }
        });
    }

    /**
     * Sorts the table data by a given column.
     * @param {string} columnKey The key in the data object to sort by.
     * @param {string} direction The direction to sort ('asc' or 'desc').
     */
    function sortTable(columnKey, direction) {
        // Remove sort arrows from all headers
        document.querySelectorAll('th').forEach(th => {
          th.classList.remove('asc', 'desc');
        });
        let header = document.getElementById('th-' + columnKey);
        header.classList.add(direction);

        tableData.sort((a, b) => {
            const valA = a[columnKey];
            const valB = b[columnKey];

            // Handle numbers for numeric sorting (e.g., slide numbers)
            const isNumeric = (typeof valA === 'number' || typeof valA === 'string' && !isNaN(parseFloat(valA))) &&
                              (typeof valB === 'number' || typeof valB === 'string' && !isNaN(parseFloat(valB)));

            let comparison = 0;
            if (isNumeric) {
                comparison = parseFloat(valA) - parseFloat(valB);
            } else {
                // Treat empty strings as coming after non-empty strings in ASC order
                // and before in DESC order for better visual grouping
                if (valA === '' && valB !== '') comparison = 1;
                else if (valA !== '' && valB === '') comparison = -1;
                else if (valA === '' && valB === '') comparison = 0;
                else {
                    comparison = String(valA).localeCompare(String(valB));
                }
            }

            return direction === 'asc' ? comparison : -comparison;
        });
        renderTable();
    }

    /**
     * Populates the filter dropdowns with unique values from each column.
     */
    function populateFilterDropdowns() {
        const columnKeys = ['sourceSlidePageNumber', 'targetPresentationName', 'targetSlidePageNumber'];
        const globalContainer = document.getElementById('global-dropdown-container');

        columnKeys.forEach(key => {
            // Create the dropdown content div
            const dropdownContent = document.createElement('div');
            dropdownContent.id = `filter-${key}`;
            dropdownContent.classList.add('dropdown-content');
            // Append it to the global container initially (it will be shown/hidden by JS)
            globalContainer.appendChild(dropdownContent);

            // Store a reference to this dropdownContent for later use
            dropdownContentCache[key] = dropdownContent;

            dropdownContent.innerHTML = ''; // Clear previous options

            // Add Sort Actions
            const sortAscBtn = document.createElement('button');
            sortAscBtn.type = 'button';
            sortAscBtn.className = 'dropdown-item';
            sortAscBtn.textContent = 'Sort Ascending';
            sortAscBtn.onclick = () => {
                sortTable(key, 'asc');
                closeDropdownAndFocusButton(key);
            };
            dropdownContent.appendChild(sortAscBtn);

            const sortDescBtn = document.createElement('button');
            sortDescBtn.type = 'button';
            sortDescBtn.className = 'dropdown-item';
            sortDescBtn.textContent = 'Sort Descending';
            sortDescBtn.onclick = () => {
                sortTable(key, 'desc');
                closeDropdownAndFocusButton(key);
            };
            dropdownContent.appendChild(sortDescBtn);

            const hr = document.createElement('hr');
            hr.className = 'dropdown-divider';
            dropdownContent.appendChild(hr);

            const uniqueValues = new Set();
            originalTableData.forEach(row => {
                uniqueValues.add(row[key]);
            });

            // Convert Set to Array, sort, and ensure blank is at the top if present
            let sortedValues = Array.from(uniqueValues).sort((a, b) => {
                // Custom sort to put (Blank) at the top
                const valA = (a === null || a === undefined || a === '') ? '' : a;
                const valB = (b === null || b === undefined || b === '') ? '' : b;

                if (valA === '' && valB !== '') return -1;
                if (valA !== '' && valB === '') return 1;
                if (valA === '' && valB === '') return 0;

                // Numeric sort for slide numbers
                if (key === 'sourceSlidePageNumber' || key === 'targetSlidePageNumber') {
                    return parseFloat(valA) - parseFloat(valB);
                }
                return String(valA).localeCompare(String(valB));
            });
            
                        // Add the (De)select All checkbox at the very top
            const selectAllLabel = document.createElement('label');
            selectAllLabel.innerHTML = '<input type="checkbox" class="select-all-toggle" data-column="' + key + '"> (De)select All';
            dropdownContent.appendChild(selectAllLabel);
            
            const selectAllCheckbox = selectAllLabel.querySelector('input');
            selectAllCheckbox.onchange = function(event) {
                toggleSelectAll(event, key); // Pass column key
            };

            // Initialize activeFilters for this column: by default, all are selected
            activeFilters[key].clear(); // Clear existing
            sortedValues.forEach(value => activeFilters[key].add(String(value)));


            sortedValues.forEach(value => {
                const displayValue = (value === '' || value === null || value === undefined) ? '(Blank)' : value;
                const checkboxId = "checkbox-" + key + "-" + value; // Unique ID for checkbox

                const label = document.createElement('label');
                label.innerHTML = "<input type=\"checkbox\" id=\"" + checkboxId + "\" data-column=\"" + key + "\" value=\"" + value + "\" onchange=\"filterTable()\"> " + displayValue;
                dropdownContent.appendChild(label);

                const checkbox = label.querySelector('input');
                // All are checked by default on initial population
                checkbox.checked = true;
            });

            // Set initial state of "Select All" checkbox to true after all options are populated
            selectAllCheckbox.checked = true;

            // Add accessibility event listeners
            dropdownContent.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.stopPropagation();
                    closeDropdownAndFocusButton(key);
                }
            });

            dropdownContent.addEventListener('focusout', (e) => {
                // If focus moves to an element not within this dropdown, close it.
                if (!dropdownContent.contains(e.relatedTarget)) {
                    dropdownContent.style.display = 'none';
                    const button = document.querySelector(`.dropdown-button[data-column="${key}"]`);
                    if (button) button.setAttribute('aria-expanded', 'false');
                }
            });
        });
    }

    /**
     * Toggles all checkboxes in a specific dropdown based on the "Select/Deselect All" checkbox.
     * @param {Event} event The change event from the (De)select All checkbox.
     * @param {string} columnKey The key of the column to toggle.
     */
    function toggleSelectAll(event, columnKey) {
        const masterCheckbox = event.target;
        const dropdownContent = dropdownContentCache[columnKey]; // Get from cache
        const checkboxes = dropdownContent.querySelectorAll('input[type="checkbox"]:not(.select-all-toggle)');

        if (masterCheckbox.checked) {
            activeFilters[columnKey].clear(); // Clear existing filters
            checkboxes.forEach(cb => {
                cb.checked = true;
                activeFilters[columnKey].add(cb.value);
            });
        } else {
            activeFilters[columnKey].clear(); // Clear all filters for this column
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
        }
        filterTable(); // Re-apply filters
    }

    /**
     * Toggles the visibility of a dropdown content.
     * @param {Event} event The click event.
     * @param {string} columnKey The key of the column for which to toggle dropdown.
     */
    function toggleDropdown(event, columnKey) {
        event.stopPropagation();
        const dropdownContent = dropdownContentCache[columnKey]; // Get from cache
        const dropdownButton = event.currentTarget; // The button that was clicked

        const wasOpen = dropdownContent.style.display === 'block';

        // Close all other dropdowns
        document.querySelectorAll('.dropdown-content').forEach(content => {
            content.style.display = 'none';
        });
        document.querySelectorAll('.dropdown-button').forEach(btn => {
            btn.setAttribute('aria-expanded', 'false');
        });

        // If the clicked one was not open, then open it.
        if (!wasOpen) {
            dropdownButton.setAttribute('aria-expanded', 'true');
            // Calculate position relative to the viewport
            const rect = dropdownButton.getBoundingClientRect();
            dropdownContent.style.left = rect.left + 'px';
            dropdownContent.style.top = (rect.bottom + 5) + 'px'; // 5px buffer below the button
            dropdownContent.style.display = 'block';
            // Focus the first focusable item in the dropdown
            const firstItem = dropdownContent.querySelector('button.dropdown-item, input[type="checkbox"]');
            if (firstItem) {
                firstItem.focus();
            }
        }
    }

    /**
     * Closes a specific dropdown and returns focus to its trigger button.
     * @param {string} columnKey The key for the column's dropdown to close.
     */
    function closeDropdownAndFocusButton(columnKey) {
        const dropdownContent = dropdownContentCache[columnKey];
        const button = document.querySelector(`.dropdown-button[data-column="${columnKey}"]`);

        if (dropdownContent) dropdownContent.style.display = 'none';
        if (button) button.setAttribute('aria-expanded', 'false');
        if (button) button.focus();
    }

    /**
     * Filters the table data based on selected dropdown values.
     */
    function filterTable() {
        // Update active filters based on current checkbox states
        const columnKeys = ['sourceSlidePageNumber', 'targetPresentationName', 'targetSlidePageNumber'];
        columnKeys.forEach(key => {
            activeFilters[key].clear(); // Clear current selections for this column
            const dropdownContent = dropdownContentCache[key]; // Get from cache
            if (dropdownContent) { // Ensure dropdownContent exists before querying
              dropdownContent.querySelectorAll('input[type="checkbox"]:checked:not(.select-all-toggle)').forEach(checkbox => {
                  activeFilters[key].add(checkbox.value);
              });
              // Update the state of the master "Select All" checkbox
              const selectAllCheckbox = dropdownContent.querySelector('.select-all-toggle');
              const allColumnCheckboxes = dropdownContent.querySelectorAll('input[type="checkbox"]:not(.select-all-toggle)');
              if (selectAllCheckbox) {
                  // If the number of checked boxes (excluding master) matches total, it's "all selected"
                  selectAllCheckbox.checked = (activeFilters[key].size === allColumnCheckboxes.length);
              }
            }
        });

        // Filter data based on active filters
        let filteredData = originalTableData.filter(row => {
            return columnKeys.every(key => {
                // A row passes the filter for a column if its value is in the activeFilters set for that column.
                // If activeFilters[key] is empty, it means no items are selected for that filter,
                // so no rows should be displayed for that column's filter criteria.
                if (activeFilters[key].size === 0) {
                    return false; // If nothing is selected in the filter, no row passes this column's filter
                }
                return activeFilters[key].has(String(row[key])); // Ensure comparison is string to string
            });
        });

        tableData = filteredData; // Update the data being displayed/sorted
        renderTable(); // Re-render the filtered data
    }

    // Close dropdowns when clicking outside
    window.onclick = function(event) {
        if (!event.target.closest('.dropdown-button') && !event.target.closest('.dropdown-content')) {
            document.querySelectorAll('.dropdown-content').forEach(content => {
                content.style.display = 'none';
            });
            document.querySelectorAll('.dropdown-button').forEach(btn => {
                btn.setAttribute('aria-expanded', 'false');
            });
        }
    };

    // Initial setup
    document.addEventListener('DOMContentLoaded', (event) => {
        populateFilterDropdowns(); // Populate dropdowns first

        // Attach event listeners and ARIA attributes to dropdown buttons
        document.querySelectorAll('.dropdown-button').forEach(button => {
            const columnKey = button.dataset.column;
            button.setAttribute('aria-haspopup', 'true');
            button.setAttribute('aria-expanded', 'false');
            button.setAttribute('aria-controls', `filter-${columnKey}`);

            button.addEventListener('click', function(event) {
                toggleDropdown(event, columnKey);
            });
        });

        // Initial sort and render when the dialog loads
        sortTable('sourceSlidePageNumber', 'asc');
    });
  </script>
</body>
</html>
